<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Headlines</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .loading {
            background: url('loading.svg') no-repeat center center;
            background-size: contain;
        }
        .disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100">
<header class="bg-green-800 text-white shadow-md">
    <div class="container mx-auto py-4 px-6 flex justify-between items-center">
        <h1 class="text-3xl font-bold">headlines-go - get all headlines in one place</h1>
        <a href="https://github.com/shaharia-lab/headlines-go" target="_blank" class="text-white underline">GitHub Repo</a>
    </div>
</header>

<nav class="bg-white shadow-md py-4">
    <div class="container mx-auto">
        <p class="text-gray-700">Welcome to headlines-go! Get the latest news from multiple sources all in one place. Toggle sources to customize your feed.</p>
    </div>
</nav>

<main class="container mx-auto p-6">
    <div class="flex justify-end mb-4">
        <label class="flex items-center">
            <input type="checkbox" id="liveRefreshToggle" class="mr-2">
            Live Refresh
        </label>
    </div>
    <div id="countdown" class="text-right text-gray-500 mb-6"></div>
    <div id="boardToggles" class="mb-6 bg-white p-4 rounded-lg shadow-md"></div>
    <div id="newsBoards" class="news-boards grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
</main>

<footer class="bg-gray-200 py-4 mt-6">
    <div class="container mx-auto text-center text-gray-700">
        &copy; 2024 headlines-go. All rights reserved.
    </div>
</footer>

<script>
    const boardColors = [
        'bg-blue-100', 'bg-green-100', 'bg-yellow-100', 'bg-red-100',
        'bg-indigo-100', 'bg-purple-100', 'bg-pink-100', 'bg-teal-100'
    ];

    let newsData = [];
    let liveRefresh = true;
    let refreshInterval;

    document.getElementById('liveRefreshToggle').addEventListener('change', (e) => {
        liveRefresh = e.target.checked;
        if (liveRefresh) {
            startRefreshTimer();
        } else {
            clearInterval(refreshInterval);
        }
    });

    async function fetchNews() {
        try {
            const response = await fetch('/api/headlines');
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            newsData = await response.json();
            displayNews(newsData);
            updateBoardToggles(newsData);
        } catch (error) {
            console.error('Failed to fetch news data:', error);
            document.getElementById('newsBoards').innerHTML = '<p class="text-red-500 text-center w-full col-span-full">Failed to load news. Please try again later.</p>';
        } finally {
            document.getElementById('newsBoards').classList.remove('loading');
        }
    }

    function displayNews(data) {
        const newsBoardsContainer = document.getElementById('newsBoards');
        newsBoardsContainer.innerHTML = '';

        data.forEach((sourceData, index) => {
            const board = createNewsBoard(sourceData, index);
            newsBoardsContainer.appendChild(board);
        });
    }

    function createNewsBoard(sourceData, index) {
        const board = document.createElement('div');
        const colorClass = boardColors[index % boardColors.length];
        board.className = `${colorClass} rounded-lg shadow-lg p-6 flex flex-col h-[600px]`;
        board.id = `board-${index}`;

        const sourceHeader = createSourceHeader(sourceData.source);
        const homepageLink = createHomepageLink(sourceData.source.homepage);

        board.appendChild(sourceHeader);
        board.appendChild(homepageLink);

        const newsList = document.createElement('ul');
        newsList.className = 'space-y-4 overflow-y-auto custom-scrollbar flex-grow';

        if (sourceData.headlines && sourceData.headlines.length > 0) {
            sourceData.headlines.forEach(article => {
                const listItem = createNewsItem(article);
                newsList.appendChild(listItem);
            });
        } else {
            const noHeadlines = document.createElement('li');
            noHeadlines.className = 'text-gray-500 text-center py-4';
            noHeadlines.textContent = 'No headlines found';
            newsList.appendChild(noHeadlines);
        }

        board.appendChild(newsList);
        return board;
    }

    function createSourceHeader(source) {
        const sourceHeader = document.createElement('div');
        sourceHeader.className = 'flex items-center mb-4 pb-2 border-b';

        const sourceLogo = document.createElement('img');
        sourceLogo.src = source.logo;
        sourceLogo.alt = `${source.name} logo`;
        sourceLogo.className = 'w-8 h-8 mr-2 rounded';

        const sourceTitle = document.createElement('h2');
        sourceTitle.className = 'text-xl font-bold text-gray-800';
        sourceTitle.textContent = source.name;

        sourceHeader.appendChild(sourceLogo);
        sourceHeader.appendChild(sourceTitle);

        return sourceHeader;
    }

    function createHomepageLink(homepage) {
        const homepageLink = document.createElement('a');
        homepageLink.href = homepage;
        homepageLink.className = 'text-sm text-blue-600 hover:text-blue-800 block mb-4';
        homepageLink.textContent = 'Visit Homepage';
        homepageLink.target = '_blank';
        homepageLink.rel = 'noopener noreferrer';
        return homepageLink;
    }

    function createNewsItem(article) {
        const listItem = document.createElement('li');
        listItem.className = 'news-item bg-white bg-opacity-60 rounded-md shadow-sm overflow-hidden';

        const link = document.createElement('a');
        link.href = article.url || '#';
        link.className = 'block p-3 hover:bg-gray-100 transition-colors duration-200';
        link.target = '_blank';
        link.rel = 'noopener noreferrer';

        const title = document.createElement('h3');
        title.className = 'text-md font-semibold text-gray-800';
        title.textContent = article.title;

        link.appendChild(title);
        listItem.appendChild(link);
        return listItem;
    }

    function updateBoardToggles(data) {
        const togglesContainer = document.getElementById('boardToggles');
        togglesContainer.innerHTML = '<h2 class="text-lg font-semibold mb-2">Toggle News Sources:</h2>';
        const togglesWrapper = document.createElement('div');
        togglesWrapper.className = 'flex flex-wrap gap-2';

        data.forEach((sourceData, index) => {
            const toggle = document.createElement('button');
            toggle.className = `px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors ${isBoardHidden(index) ? 'disabled' : ''}`;
            toggle.textContent = sourceData.source.name;
            toggle.onclick = () => toggleBoard(index, toggle);
            togglesWrapper.appendChild(toggle);
        });

        togglesContainer.appendChild(togglesWrapper);
    }

    function toggleBoard(index, button) {
        const board = document.getElementById(`board-${index}`);
        if (board) {
            board.classList.toggle('hidden');
            button.classList.toggle('disabled');
            saveBoardState(index, !board.classList.contains('hidden'));
        }
    }

    function isBoardHidden(index) {
        const boardState = JSON.parse(localStorage.getItem('boardState')) || {};
        return !boardState[`board-${index}`];
    }

    function saveBoardState(index, isVisible) {
        const boardState = JSON.parse(localStorage.getItem('boardState')) || {};
        boardState[`board-${index}`] = isVisible;
        localStorage.setItem('boardState', JSON.stringify(boardState));
    }

    function startRefreshTimer() {
        let countdown = 10;
        const countdownElement = document.getElementById('countdown');
        countdownElement.textContent = `Refreshing in ${countdown}s`;

        refreshInterval = setInterval(() => {
            if (!liveRefresh) return;
            countdown--;
            countdownElement.textContent = `Refreshing in ${countdown}s`;

            if (countdown === 0) {
                fetchNews();
                countdown = 10;
            }
        }, 1000);
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('liveRefreshToggle').checked = true;
        fetchNews();
        startRefreshTimer();
    });

</script>
</body>
</html>
